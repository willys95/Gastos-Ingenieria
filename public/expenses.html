<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gastos · Control de Proyectos</title>
  <link rel="stylesheet" href="./styles.css"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"/>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <button id="menu-toggle" class="menu-toggle">☰</button> 
      <img class="brand__logo" src="./assets/logo.png" alt="Logo"/>
      <div class="brand__title">Control de Proyectos</div>
    </div>
    <div class="topbar__right">
      <span class="badge" id="user-badge">Sin sesión</span>
      <button class="button button--ghost" id="logout-btn" type="button">Salir</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <nav class="nav">
        <a href="./dashboard.html" class="">Panel</a>
        <a href="./clients.html" class="" data-role="manageProjects">Clientes</a>
        <a href="./projects.html" class="" data-role="manageProjects">Proyectos</a>
        <a href="./expenses.html" class="is-active">Gastos</a>
        <a href="./reports.html" class="">Reportes</a>
        <a href="./users.html" class="" data-role="adminOnly">Usuarios</a>
      </nav>
      <div class="sidebar__meta">
        <div><b>Hosting:</b> Firebase</div>
        <div><b>Datos:</b> Firestore + Storage</div>
      </div>
    </aside>

    <main class="main">
      
      <div>
        <h1 class="h1">Gastos</h1>
        <p class="sub">Registra gastos. El saldo se descuenta automáticamente del proyecto.</p>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Registrar gasto</h3>
          <form class="form" id="e-form">
            <label>Cliente
              <select id="e-client" required></select>
            </label>
            <label>Proyecto
              <select id="e-project" required disabled><option>Seleccione cliente...</option></select>
            </label>
            
            <div id="project-info" style="font-size:0.9rem; color:#64748b; margin-bottom:1rem; display:none; background:#f8fafc; padding:8px; border-radius:4px;">
              Saldo: <b id="p-balance" style="color:#0f172a;">$0</b>
              <br><small id="p-resp-label">Resp: ...</small>
            </div>

            <div class="row">
              <label>Fecha
                <input id="e-date" type="date" required/>
              </label>
              <label>Valor
                <input id="e-amount" type="number" min="1" required/>
              </label>
            </div>
            <label>Concepto
              <select id="e-category" required></select>
            </label>
            <label>Descripción
              <textarea id="e-desc" rows="3" required></textarea>
            </label>
            <label>Soporte (foto)
              <input id="e-file" type="file" accept="image/*" required/>
            </label>
            <button class="button" type="submit">Guardar y Descontar</button>
            <p class="notice" id="e-msg"></p>
          </form>
        </div>

        <div class="card">
          <h3 id="list-title">Historial Reciente</h3>
          <p class="sub" id="list-subtitle">Cargando...</p>
          <div class="list" id="e-list"></div>
        </div>
      </div>

      <script type="module">
        import { db, storage, fb } from "./js/firebase.js";
        import { increment } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
        import { requireAuth, fillUserBadge, setActiveNav, setNotice, qsa, logout } from "./js/common.js";

        // 1. Auth
        const { user, profile, role } = await requireAuth();
        fillUserBadge(profile);
        setActiveNav();
        document.querySelector("#logout-btn")?.addEventListener("click", logout);

        const manage = role === "admin" || role === "lider";
        qsa('[data-role="manageProjects"]').forEach(a => a.classList.toggle("hidden", !manage));
        qsa('[data-role="adminOnly"]').forEach(a => a.classList.toggle("hidden", role !== "admin"));

        // DOM
        const form = document.querySelector("#e-form");
        const msg = document.querySelector("#e-msg");
        const list = document.querySelector("#e-list");
        const clientSel = document.querySelector("#e-client");
        const projectSel = document.querySelector("#e-project");
        const catSel = document.querySelector("#e-category");
        const fileInput = document.querySelector("#e-file");
        const balanceInfo = document.querySelector("#project-info");
        const balanceDisplay = document.querySelector("#p-balance");
        const respDisplay = document.querySelector("#p-resp-label");

        // Configuración de vista
        if(!manage){
            document.getElementById("list-title").textContent = "Mis Gastos Recientes";
            document.getElementById("list-subtitle").textContent = "Registros creados por ti.";
        } else {
            document.getElementById("list-subtitle").textContent = "Últimos registros globales.";
        }

        const DEFAULT_CATEGORIES = [
          "Transporte","Alimentación","Hospedaje","Compra de materiales",
          "Pago a terceros","Impuestos","Servicios","Viáticos","Nómina","Otros"
        ];

        // --- COMPRESIÓN ---
        async function compressImage(file, { quality = 0.6, maxWidth = 1200 } = {}) {
            return new Promise((resolve, reject) => {
                if (!file) return reject(new Error("No file"));
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        let w = img.width, h = img.height;
                        if (w > maxWidth) { h = Math.round((h*maxWidth)/w); w=maxWidth; }
                        const canvas = document.createElement('canvas');
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img,0,0,w,h);
                        canvas.toBlob((blob) => {
                            if(!blob) return reject(new Error("Error compresión"));
                            resolve(new File([blob], file.name.replace(/\.[^/.]+$/, "")+".jpg", {type:"image/jpeg"}));
                        }, 'image/jpeg', quality);
                    };
                };
            });
        }

        function opt(sel,v,l){ const o=document.createElement("option"); o.value=v; o.textContent=l; sel.append(o); }
        function money(n){return `$${Number(n||0).toLocaleString()}`;}

        let allClients = [];
        let validProjects = [];

        async function loadData(){
            // 1. Cargar Proyectos (Todos para filtrar en memoria o query directo)
            const qProjects = fb.query(fb.collection(db,"projects"), fb.orderBy("createdAt","desc"));
            const snapProj = await fb.getDocs(qProjects);
            let rawProjects = snapProj.docs.map(d=>({id:d.id, ...d.data()}));

            // Filtro para selectores: Si es empleado, solo donde es Resp o Aux
            if(!manage){
                rawProjects = rawProjects.filter(p => p.responsibleUid === user.uid || p.auxiliaryUid === user.uid);
            }

            // Filtrar solo Activos Y con Saldo > 0
            validProjects = rawProjects.filter(p => {
                const rem = (p.baseAmount||0) - (p.spent||0);
                return (p.status||'activo')==='activo' && rem > 0;
            });

            // 2. Clientes
            const snapClients = await fb.getDocs(fb.query(fb.collection(db,"clients"), fb.orderBy("name")));
            const rawClients = snapClients.docs.map(d=>({id:d.id, ...d.data()}));
            const validClientIds = new Set(validProjects.map(p => p.clientId));
            allClients = rawClients.filter(c => validClientIds.has(c.id));

            renderClientSelect();
        }

        function renderClientSelect(){
            clientSel.innerHTML=""; opt(clientSel,"","Seleccione Cliente");
            allClients.forEach(c => opt(clientSel, c.id, `${c.name} - ${c.city}`));
        }

        clientSel.addEventListener("change", () => {
            projectSel.innerHTML=""; opt(projectSel,"","Seleccione Proyecto");
            projectSel.disabled=true; balanceInfo.style.display="none";
            const cid = clientSel.value;
            if(!cid) return;
            const list = validProjects.filter(p => p.clientId === cid);
            list.forEach(p => opt(projectSel, p.id, p.code));
            projectSel.disabled=false;
        });

        projectSel.addEventListener("change", () => {
            const pid = projectSel.value;
            if(!pid){ balanceInfo.style.display="none"; return; }
            const p = validProjects.find(x=>x.id===pid);
            if(p){
                const rem = (p.baseAmount||0) - (p.spent||0);
                balanceDisplay.textContent = money(rem);
                respDisplay.textContent = `Resp: ${p.responsibleName || 'N/A'}`;
                balanceInfo.style.display="block";
            }
        });

        async function renderExpenses(){
          list.innerHTML="";
          let q;

          // LOGICA DE CONSULTA SEGUN ROL
          if(manage){
             // Admin ve todo
             q = fb.query(fb.collection(db,"expenses"), fb.orderBy("createdAt","desc"), fb.limit(20));
          } else {
             // Empleado ve SOLO SUS GASTOS (Más seguro y evita listas vacías)
             q = fb.query(
                fb.collection(db,"expenses"), 
                fb.where("createdByUid", "==", user.uid), 
                fb.orderBy("createdAt","desc"), 
                fb.limit(20)
             );
          }

          try {
              const snap = await fb.getDocs(q);
              const expenses = snap.docs.map(d=>({id:d.id,...d.data()}));
              
              if(!expenses.length){ list.innerHTML=`<p class="sub">Sin registros recientes.</p>`; return; }

              expenses.forEach(e=>{
                const item=document.createElement("div");
                item.className="item";
                item.innerHTML=`
                  <div class="item__head"><span>${e.category}</span><span>${money(e.amount)}</span></div>
                  <div class="item__meta">${e.date} · ${e.projectName}</div>
                  <div class="item__meta">
                    Por: ${e.createdByName} 
                    ${e.receiptUrl ? ` · <a href="${e.receiptUrl}" target="_blank">Ver foto</a>` : ''}
                  </div>
                `;
                list.append(item);
              });
          } catch(err) {
              console.error("Error cargando gastos:", err);
              list.innerHTML = `<p class="notice is-error">Error cargando lista. Verifica permisos.</p>`;
          }
        }

        form.addEventListener("submit", async (e)=>{
          e.preventDefault();
          try{
            setNotice(msg,"Validando...", "loading");
            const cid = clientSel.value;
            const pid = projectSel.value;
            const amount = Number(document.querySelector("#e-amount").value);
            
            const project = validProjects.find(p => p.id === pid);
            if(!project) throw new Error("Proyecto inválido.");

            const currentRem = (project.baseAmount||0) - (project.spent||0);
            if(amount > currentRem) throw new Error(`Fondos insuficientes. Disp: ${money(currentRem)}`);

            const file = fileInput.files?.[0];
            if(!file) throw new Error("Falta foto.");
            
            setNotice(msg,"Subiendo foto...", "loading");
            const compressed = await compressImage(file);
            const path = `receipts/${pid}/${Date.now()}_${compressed.name.replace(/[^a-zA-Z0-9]/g,"")}`;
            const ref = fb.ref(storage, path);
            await fb.uploadBytes(ref, compressed);
            const url = await fb.getDownloadURL(ref);

            setNotice(msg,"Registrando...", "loading");
            const payload = {
              clientId: cid,
              clientName: allClients.find(c=>c.id===cid)?.name || "",
              projectId: pid,
              projectName: `${project.code} · ${project.name||''}`,
              date: document.querySelector("#e-date").value,
              amount: amount,
              category: catSel.value,
              description: document.querySelector("#e-desc").value.trim(),
              receiptUrl: url,
              receiptName: compressed.name,
              createdByUid: user.uid,
              createdByName: profile.name || profile.email,
              createdAt: fb.serverTimestamp(),
            };

            await fb.addDoc(fb.collection(db,"expenses"), payload);

            // Actualizar saldo proyecto
            const updates = { spent: increment(amount) };
            if(((project.spent||0) + amount) >= (project.baseAmount||0)){
                updates.status = "inactivo";
            }
            await fb.updateDoc(fb.doc(db,"projects", pid), updates);

            form.reset();
            balanceInfo.style.display="none";
            setNotice(msg, updates.status==="inactivo" ? "Guardado. Proyecto CERRADO (Saldo 0)." : "Gasto guardado.", "success");
            
            await loadData();
            await renderExpenses();

          }catch(err){ console.error(err); setNotice(msg, err.message, "error"); }
        });

        catSel.innerHTML=""; DEFAULT_CATEGORIES.forEach(c=>opt(catSel,c,c));
        await loadData();
        await renderExpenses();
      </script>
    </main>
  </div>
</body>
</html>