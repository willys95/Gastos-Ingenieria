<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gastos · Control de Proyectos</title>
  <link rel="stylesheet" href="./styles.css"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"/>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <button id="menu-toggle" class="menu-toggle">☰</button> 
      <img class="brand__logo" src="./assets/logo.png" alt="Logo"/>
      <div class="brand__title">Control de Proyectos</div>
    </div>
    <div class="topbar__right">
      <span class="badge" id="user-badge">Sin sesión</span>
      <button class="button button--ghost" id="logout-btn" type="button">Salir</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <nav class="nav">
        <a href="./dashboard.html" class="">Panel</a>
        <a href="./clients.html" class="" data-role="manageProjects">Clientes</a>
        <a href="./projects.html" class="" data-role="manageProjects">Proyectos</a>
        <a href="./expenses.html" class="is-active">Gastos</a>
        <a href="./users.html" class="" data-role="adminOnly">Usuarios</a>
      </nav>
      <div class="sidebar__meta">
        <div><b>Hosting:</b> Firebase</div>
        <div><b>Datos:</b> Firestore + Storage</div>
      </div>
    </aside>

    <main class="main">
      
      <div>
        <h1 class="h1">Gastos</h1>
        <p class="sub">Registra gastos por proyecto. Los empleados solo ven sus proyectos asignados.</p>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Registrar gasto</h3>
          <form class="form" id="e-form">
            <label>Cliente
              <select id="e-client" required></select>
            </label>
            <label>Proyecto
              <select id="e-project" required></select>
            </label>
            <div class="row">
              <label>Fecha
                <input id="e-date" type="date" required/>
              </label>
              <label>Valor
                <input id="e-amount" type="number" min="1" required/>
              </label>
            </div>
            <label>Concepto
              <select id="e-category" required></select>
            </label>
            <label>Descripción
              <textarea id="e-desc" rows="3" required></textarea>
            </label>
            <label>Soporte (foto)
              <input id="e-file" type="file" accept="image/*" required/>
            </label>
            <div class="file-preview" id="e-preview">
              <span class="file-preview__label">Sin archivo</span>
            </div>
            <button class="button" type="submit">Guardar</button>
            <p class="notice" id="e-msg"></p>
          </form>
          <p class="sub" style="margin-top:10px;font-size:12px;">El archivo se guarda en Firebase Storage (comprimido).</p>
        </div>

        <div class="card">
          <h3>Historial</h3>
          <p>Últimos registros visibles para tu rol.</p>
          <div class="list" id="e-list"></div>
        </div>
      </div>

      <script type="module">
        import { db, storage, fb } from "./js/firebase.js";
        import { requireAuth, fillUserBadge, setActiveNav, setNotice, qsa, logout } from "./js/common.js";

        // 1. Autenticación
        const { user, profile, role } = await requireAuth();
        fillUserBadge(profile);
        setActiveNav();
        document.querySelector("#logout-btn")?.addEventListener("click", logout);

        const manage = role === "admin" || role === "lider";
        qsa('[data-role="manageProjects"]').forEach(a => a.classList.toggle("hidden", !manage));
        qsa('[data-role="adminOnly"]').forEach(a => a.classList.toggle("hidden", role !== "admin"));

        // 2. Variables
        const form = document.querySelector("#e-form");
        const msg = document.querySelector("#e-msg");
        const list = document.querySelector("#e-list");
        const clientSel = document.querySelector("#e-client");
        const projectSel = document.querySelector("#e-project");
        const catSel = document.querySelector("#e-category");
        const fileInput = document.querySelector("#e-file");
        const preview = document.querySelector("#e-preview");

        const DEFAULT_CATEGORIES = [
          "Transporte","Alimentación","Hospedaje","Compra de materiales",
          "Pago a terceros","Impuestos","Servicios","Viáticos","Nómina","Otros"
        ];

        // --- FUNCIÓN DE COMPRESIÓN ---
        async function compressImage(file, { quality = 0.7, maxWidth = 1024 } = {}) {
          return new Promise((resolve, reject) => {
            if (!file.type.startsWith("image/")) {
              return reject(new Error("El archivo no es una imagen válida."));
            }

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
              const img = new Image();
              img.src = event.target.result;
              img.onload = () => {
                let width = img.width;
                let height = img.height;
                if (width > maxWidth) {
                  height = Math.round((height * maxWidth) / width);
                  width = maxWidth;
                }
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                canvas.toBlob((blob) => {
                  if (!blob) return reject(new Error("Fallo al procesar imagen."));
                  const newFile = new File([blob], file.name.replace(/\.[^/.]+$/, "") + ".jpg", {
                    type: "image/jpeg",
                    lastModified: Date.now(),
                  });
                  resolve(newFile);
                }, 'image/jpeg', quality);
              };
              img.onerror = () => reject(new Error("Imagen corrupta."));
            };
            reader.onerror = () => reject(new Error("Error leyendo archivo."));
          });
        }
        // -----------------------------

        function opt(sel,value,label){
          const o=document.createElement("option"); o.value=value; o.textContent=label; sel.append(o);
        }
        function money(n){return `$${Number(n||0).toLocaleString()}`;}

        function setPreview(file){
          preview.innerHTML="";
          if(!file){ preview.innerHTML='<span class="file-preview__label">Sin archivo</span>'; return; }
          const img=document.createElement("img");
          img.src = URL.createObjectURL(file);
          const label=document.createElement("span");
          label.className="file-preview__label";
          label.textContent=file.name;
          preview.append(img,label);
        }
        fileInput.addEventListener("change", ()=> setPreview(fileInput.files?.[0] || null));

        let clients = [];
        let projects = [];

        async function loadVisibleProjects(){
          if(manage){
            const snap = await fb.getDocs(fb.query(fb.collection(db,"projects"), fb.orderBy("createdAt","desc")));
            projects = snap.docs.map(d=>({id:d.id,...d.data()}));
          }else{
            const q = fb.query(fb.collection(db,"projects"), fb.where("responsibleUid","==", user.uid), fb.orderBy("createdAt","desc"));
            const snap = await fb.getDocs(q);
            projects = snap.docs.map(d=>({id:d.id,...d.data()}));
          }
        }

        async function loadClients(){
          const snap = await fb.getDocs(fb.query(fb.collection(db,"clients"), fb.orderBy("name")));
          clients = snap.docs.map(d=>({id:d.id,...d.data()}));
          if(!manage){
            const clientIds = new Set(projects.map(p=>p.clientId));
            clients = clients.filter(c=>clientIds.has(c.id));
          }
        }

        // MOSTRAR NOMBRE Y CIUDAD
        function renderClientSelect(){
          clientSel.innerHTML="";
          opt(clientSel,"","Seleccione");
          clients.forEach(c => {
             // Muestra "Davivienda - Cartagena"
             opt(clientSel, c.id, `${c.name} - ${c.city}`); 
          });
        }

        function renderProjectSelect(){
          projectSel.innerHTML="";
          opt(projectSel,"","Seleccione");
          const cid = clientSel.value;
          const list = projects.filter(p=>p.clientId===cid);
          list.forEach(p=>opt(projectSel,p.id, `${p.code} · ${p.name || ""}`));
        }

        function renderCategories(){
          catSel.innerHTML="";
          opt(catSel,"","Seleccione");
          DEFAULT_CATEGORIES.forEach(c=>opt(catSel,c,c));
        }

        clientSel.addEventListener("change", renderProjectSelect);

        async function renderExpenses(){
          list.innerHTML="";
          const q = fb.query(fb.collection(db,"expenses"), fb.orderBy("createdAt","desc"), fb.limit(60));
          const snap = await fb.getDocs(q);
          let expenses = snap.docs.map(d=>({id:d.id,...d.data()}));

          if(!manage){
            const my = new Set(projects.map(p=>p.id));
            expenses = expenses.filter(e=>my.has(e.projectId));
          }

          if(!expenses.length){
            list.innerHTML = `<p class="sub">Aún no hay gastos.</p>`;
            return;
          }

          expenses.slice(0,20).forEach(e=>{
            const item=document.createElement("div");
            item.className="item";
            item.innerHTML=`
              <div class="item__head">
                <span>${e.category || "Gasto"}</span>
                <span>${money(e.amount)}</span>
              </div>
              <div class="item__meta">${e.date || ""} · ${e.projectName || ""}</div>
              <div class="item__meta">${e.description || ""}</div>
              <div class="item__meta">Soporte: ${
                e.receiptUrl ? `<a href="${e.receiptUrl}" target="_blank" rel="noreferrer">ver</a>` : "—"
              }</div>
            `;
            list.append(item);
          });
        }

        form.addEventListener("submit", async (e)=>{
          e.preventDefault();
          try{
            setNotice(msg,"Preparando imagen...","loading");
            
            const cid = clientSel.value;
            const pid = projectSel.value;
            const client = clients.find(c=>c.id===cid);
            const project = projects.find(p=>p.id===pid);
            if(!project){ setNotice(msg,"Selecciona un proyecto.","error"); return; }
            if(!manage && project.responsibleUid !== user.uid){
              setNotice(msg,"No tienes permiso sobre este proyecto.","error"); return;
            }

            const originalFile = fileInput.files?.[0];
            if(!originalFile){ setNotice(msg,"Adjunta el soporte (foto).","error"); return; }

            // COMPRESIÓN
            const compressedFile = await compressImage(originalFile, { quality: 0.7, maxWidth: 1024 });

            setNotice(msg,"Subiendo...","loading");

            // SUBIDA
            const safeName = compressedFile.name.replace(/[^a-zA-Z0-9._-]/g,"_");
            const path = `receipts/${pid}/${Date.now()}_${safeName}`;
            const storageRef = fb.ref(storage, path);
            await fb.uploadBytes(storageRef, compressedFile);
            const url = await fb.getDownloadURL(storageRef);

            // GUARDADO DATOS
            const payload = {
              clientId: cid,
              clientName: client?.name || "",
              projectId: pid,
              projectName: `${project.code} · ${project.name || ""}`,
              date: document.querySelector("#e-date").value,
              amount: Number(document.querySelector("#e-amount").value),
              category: catSel.value,
              description: document.querySelector("#e-desc").value.trim(),
              receiptUrl: url,
              receiptName: compressedFile.name,
              createdByUid: user.uid,
              createdByName: profile.name || profile.email || "",
              createdAt: fb.serverTimestamp(),
            };

            await fb.addDoc(fb.collection(db,"expenses"), payload);

            form.reset();
            setPreview(null);
            setNotice(msg,"Gasto guardado.","success");
            await renderExpenses();
          }catch(err){
            console.error("ERROR GUARDANDO:", err);
            setNotice(msg, "Error: " + (err.message || "No se pudo guardar."), "error");
          }
        });

        // Init
        renderCategories();
        await loadVisibleProjects();
        await loadClients();
        renderClientSelect();
        renderProjectSelect();
        await renderExpenses();
      </script>

    </main>
  </div>
</body>
</html>