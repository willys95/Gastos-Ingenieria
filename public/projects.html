<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Proyectos · Control de Proyectos</title>
  <link rel="stylesheet" href="./styles.css"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"/>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img class="brand__logo" src="./assets/logo.png" alt="Logo"/>
      <div class="brand__title">Control de Proyectos</div>
    </div>
    <div class="topbar__right">
      <span class="badge" id="user-badge">Sin sesión</span>
      <button class="button button--ghost" id="logout-btn" type="button">Salir</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <nav class="nav">
        <a href="./dashboard.html" class="">Panel</a>
        <a href="./clients.html" class="" data-role="manageProjects">Clientes</a>
        <a href="./projects.html" class="is-active" data-role="manageProjects">Proyectos</a>
        <a href="./expenses.html" class="">Gastos</a>
        <a href="./users.html" class="" data-role="adminOnly">Usuarios</a>
      </nav>
      <div class="sidebar__meta">
        <div><b>Hosting:</b> Firebase</div>
        <div><b>Datos:</b> Firestore + Storage</div>
      </div>
    </aside>

    <main class="main">
      
  <div>
    <h1 class="h1">Proyectos</h1>
    <p class="sub">Crea proyectos, asigna responsable y base inicial.</p>
  </div>

  <div class="grid">
    <div class="card">
      <h3>Crear proyecto</h3>
      <form class="form" id="p-form">
        <label>Cliente
          <select id="p-client" required></select>
        </label>
        <div class="row">
          <label>Código
            <input id="p-code" required/>
          </label>
          <label>Ciudad
            <input id="p-city" required/>
          </label>
        </div>
        <label>Nombre
          <input id="p-name" required/>
        </label>
        <label>Responsable (empleado)
          <select id="p-resp" required></select>
        </label>
        <label>Base inicial
          <input id="p-base" type="number" min="1" required/>
        </label>
        <label>Notas (opcional)
          <textarea id="p-notes" rows="3"></textarea>
        </label>
        <button class="button" type="submit">Guardar</button>
        <p class="notice" id="p-msg"></p>
      </form>
    </div>

    <div class="card">
      <h3>Listado</h3>
      <p>Activa/inactiva proyectos (admin/líder).</p>
      <div class="list" id="p-list"></div>
    </div>
  </div>

  <script type="module">
    import { db, fb } from "./js/firebase.js";
    import { requireAuth, fillUserBadge, setActiveNav, setNotice, qsa } from "./js/common.js";

    const { profile, role } = await requireAuth({ allowedRoles:["admin","lider"] });
    fillUserBadge(profile);
    setActiveNav();

    qsa('[data-role="manageProjects"]').forEach(a => a.classList.remove("hidden"));
    qsa('[data-role="adminOnly"]').forEach(a => a.classList.toggle("hidden", role !== "admin"));

    const form = document.querySelector("#p-form");
    const msg = document.querySelector("#p-msg");
    const list = document.querySelector("#p-list");
    const clientSel = document.querySelector("#p-client");
    const respSel = document.querySelector("#p-resp");

    function opt(sel, value, label){
      const o=document.createElement("option"); o.value=value; o.textContent=label; sel.append(o);
    }

    async function loadClients(){
      clientSel.innerHTML="";
      opt(clientSel,"","Seleccione");
      const snap = await fb.getDocs(fb.query(fb.collection(db,"clients"), fb.orderBy("name")));
      snap.docs.forEach(d=> opt(clientSel,d.id, d.data().name));
    }

    async function loadEmployees(){
      respSel.innerHTML="";
      opt(respSel,"","Seleccione");
      const snap = await fb.getDocs(fb.query(fb.collection(db,"users"), fb.where("role","==","empleado"), fb.orderBy("name")));
      snap.docs.forEach(d=>{
        const u=d.data();
        opt(respSel,d.id, u.name || u.email || d.id);
      });
    }

    async function renderProjects(){
      list.innerHTML="";
      const snap = await fb.getDocs(fb.query(fb.collection(db,"projects"), fb.orderBy("createdAt","desc")));
      const projects = snap.docs.map(d=>({id:d.id, ...d.data()}));
      if(!projects.length){
        list.innerHTML = `<p class="sub">Aún no hay proyectos.</p>`;
        return;
      }
      projects.forEach(p=>{
        const item=document.createElement("div");
        item.className="item";
        item.innerHTML=`
          <div class="item__head">
            <span>${p.clientName || "Cliente"} · ${p.code || ""}</span>
            <span>$${Number(p.baseAmount||0).toLocaleString()}</span>
          </div>
          <div class="item__meta">${p.name||""} · ${p.city||""}</div>
          <div class="item__meta">Responsable: ${p.responsibleName||""}</div>
          <div class="item__meta">
            Estado:
            <select data-id="${p.id}" class="status">
              <option value="activo" ${ (p.status||"activo")==="activo" ? "selected":"" }>Activo</option>
              <option value="inactivo" ${ (p.status||"activo")==="inactivo" ? "selected":"" }>Inactivo</option>
            </select>
          </div>
        `;
        list.append(item);
      });
    }

    list.addEventListener("change", async (e)=>{
      const sel=e.target;
      if(!(sel instanceof HTMLSelectElement)) return;
      if(!sel.classList.contains("status")) return;
      try{
        await fb.updateDoc(fb.doc(db,"projects", sel.dataset.id), { status: sel.value });
      }catch(err){ console.error(err); }
    });

    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      try{
        setNotice(msg,"Guardando...","loading");
        const clientId = clientSel.value;
        const clientDoc = await fb.getDoc(fb.doc(db,"clients", clientId));
        const client = clientDoc.data();
        const respId = respSel.value;
        const respDoc = await fb.getDoc(fb.doc(db,"users", respId));
        const resp = respDoc.data();

        const payload = {
          clientId,
          clientName: client?.name || "",
          code: document.querySelector("#p-code").value.trim(),
          name: document.querySelector("#p-name").value.trim(),
          city: document.querySelector("#p-city").value.trim(),
          responsibleUid: respId,
          responsibleName: resp?.name || resp?.email || "",
          baseAmount: Number(document.querySelector("#p-base").value),
          status: "activo",
          notes: document.querySelector("#p-notes").value.trim(),
          createdAt: fb.serverTimestamp(),
        };
        await fb.addDoc(fb.collection(db,"projects"), payload);
        form.reset();
        setNotice(msg,"Proyecto creado.","success");
        await renderProjects();
      }catch(err){
        console.error(err);
        setNotice(msg,"No se pudo guardar.","error");
      }
    });

    await loadClients();
    await loadEmployees();
    await renderProjects();
  </script>

    </main>
  </div>

  <script type="module">
    import { requireAuth, setActiveNav, fillUserBadge, logout, qsa } from "./js/common.js";
    const { profile, role } = await requireAuth();
    fillUserBadge(profile);
    setActiveNav();
    document.querySelector("#logout-btn")?.addEventListener("click", logout);

    // Ocultar links según rol
    const manage = role === "admin" || role === "lider";
    qsa('[data-role="manageProjects"]').forEach(a => a.classList.toggle("hidden", !manage));
    qsa('[data-role="adminOnly"]').forEach(a => a.classList.toggle("hidden", role !== "admin"));
  </script>
</body>
</html>
