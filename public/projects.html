<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Proyectos · Control de Proyectos</title>
  <link rel="stylesheet" href="./styles.css"/>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap"/>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <button id="menu-toggle" class="menu-toggle">☰</button>
      <img class="brand__logo" src="./assets/logo.png" alt="Logo"/>
      <div class="brand__title">Control de Proyectos</div>
    </div>
    <div class="topbar__right">
      <span class="badge" id="user-badge">Sin sesión</span>
      <button class="button button--ghost" id="logout-btn" type="button">Salir</button>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <nav class="nav">
        <a href="./dashboard.html" class="">Panel</a>
        <a href="./clients.html" class="" data-role="manageProjects">Clientes</a>
        <a href="./projects.html" class="is-active" data-role="manageProjects">Proyectos</a>
        <a href="./expenses.html" class="">Gastos</a>
        <a href="./users.html" class="" data-role="adminOnly">Usuarios</a>
      </nav>
      <div class="sidebar__meta">
        <div><b>Hosting:</b> Firebase</div>
        <div><b>Datos:</b> Firestore + Storage</div>
      </div>
    </aside>

    <main class="main">
      
      <div>
        <h1 class="h1">Proyectos</h1>
        <p class="sub">Crea proyectos con código automático. El código se basa en Cliente-Ciudad.</p>
      </div>

      <div class="grid">
        <div class="card">
          <h3>Crear proyecto</h3>
          <form class="form" id="p-form">
            <label>Cliente
              <select id="p-client" required>
                <option value="">Cargando...</option>
              </select>
            </label>

            <div class="row">
              <label>Ciudad
                <select id="p-city" required disabled>
                  <option value="">Seleccione Cliente primero</option>
                </select>
              </label>
              
              <label>Código (Automático)
                <input id="p-code" readonly placeholder="Ej: DAV-CAR-0001" style="background:#f1f5f9; cursor:not-allowed; font-weight:bold;"/>
              </label>
            </div>

            <label>Responsable
              <select id="p-resp" required></select>
            </label>
            
            <label>Base inicial
              <input id="p-base" type="number" min="1" required/>
            </label>
            <label>Notas (opcional)
              <textarea id="p-notes" rows="3"></textarea>
            </label>
            <button class="button" type="submit">Guardar Proyecto</button>
            <p class="notice" id="p-msg"></p>
          </form>
        </div>

        <div class="card">
          <h3>Listado</h3>
          <p>Proyectos activos e inactivos.</p>
          <div class="list" id="p-list"></div>
        </div>
      </div>

      <script type="module">
        import { db, fb } from "./js/firebase.js";
        // Importamos 'logout' aquí directamente
        import { requireAuth, fillUserBadge, setActiveNav, setNotice, qsa, logout } from "./js/common.js";

        // 1. Autenticación y UI Básica
        const { profile, role } = await requireAuth({ allowedRoles:["admin","lider"] });
        fillUserBadge(profile);
        setActiveNav();
        
        // 2. Configurar Botón Salir
        document.querySelector("#logout-btn")?.addEventListener("click", logout);

        // 3. Manejo de Roles
        qsa('[data-role="manageProjects"]').forEach(a => a.classList.remove("hidden"));
        qsa('[data-role="adminOnly"]').forEach(a => a.classList.toggle("hidden", role !== "admin"));

        // 4. Lógica de Proyectos
        const form = document.querySelector("#p-form");
        const msg = document.querySelector("#p-msg");
        const list = document.querySelector("#p-list");
        const clientSel = document.querySelector("#p-client");
        const citySel = document.querySelector("#p-city");
        const codeInput = document.querySelector("#p-code");
        const respSel = document.querySelector("#p-resp");

        let allClients = []; 
        let allProjects = []; 

        function opt(sel, value, label){
          const o=document.createElement("option"); o.value=value; o.textContent=label; sel.append(o);
        }

        // A. Cargar Clientes
        async function loadClients(){
          clientSel.innerHTML="";
          opt(clientSel,"","Seleccione Cliente");
          
          const snap = await fb.getDocs(fb.query(fb.collection(db,"clients"), fb.orderBy("name")));
          allClients = snap.docs.map(d => ({id:d.id, ...d.data()}));
          
          const uniqueNames = [...new Set(allClients.map(c => c.name))];
          uniqueNames.forEach(name => {
            opt(clientSel, name, name); 
          });
        }

        // B. Cargar Responsables
        async function loadResponsibles(){
          respSel.innerHTML="";
          opt(respSel,"","Seleccione");
          const snap = await fb.getDocs(fb.collection(db,"users"));
          const users = snap.docs.map(d=>({id:d.id, ...d.data()}));
          
          const allowed = users.filter(u => u.role === "empleado" || u.role === "lider");
          allowed.sort((a,b) => (a.name||"").localeCompare(b.name||""));
          
          allowed.forEach(u => {
            opt(respSel, u.id, `${u.name} (${u.role.toUpperCase()})`);
          });
        }

        // C. Cargar Proyectos
        async function loadProjectsData(){
          const snap = await fb.getDocs(fb.query(fb.collection(db,"projects"), fb.orderBy("createdAt","desc")));
          allProjects = snap.docs.map(d=>({id:d.id, ...d.data()}));
          renderProjectsList();
        }

        function renderProjectsList(){
          list.innerHTML="";
          if(!allProjects.length){
            list.innerHTML = `<p class="sub">Aún no hay proyectos.</p>`;
            return;
          }
          allProjects.forEach(p=>{
            const item=document.createElement("div");
            item.className="item";
            item.innerHTML=`
              <div class="item__head">
                <span>${p.code}</span>
                <span>$${Number(p.baseAmount||0).toLocaleString()}</span>
              </div>
              <div class="item__meta">${p.clientName} - ${p.city}</div>
              <div class="item__meta">Resp: ${p.responsibleName||""}</div>
              <div class="item__meta">
                Estado:
                <select data-id="${p.id}" class="status">
                  <option value="activo" ${ (p.status||"activo")==="activo" ? "selected":"" }>Activo</option>
                  <option value="inactivo" ${ (p.status||"activo")==="inactivo" ? "selected":"" }>Inactivo</option>
                </select>
              </div>
            `;
            list.append(item);
          });
        }

        // INTERACCIÓN: Cliente -> Ciudad
        clientSel.addEventListener("change", ()=>{
          const selectedName = clientSel.value;
          citySel.innerHTML = "";
          opt(citySel, "", "Seleccione Ciudad");
          codeInput.value = ""; 

          if(!selectedName){
            citySel.disabled = true;
            return;
          }

          const matches = allClients.filter(c => c.name === selectedName);
          matches.forEach(m => opt(citySel, m.city, m.city));
          citySel.disabled = false;
        });

        // INTERACCIÓN: Ciudad -> Código
        citySel.addEventListener("change", generateCode);

        function generateCode(){
          const clientName = clientSel.value;
          const cityName = citySel.value;

          if(!clientName || !cityName){
            codeInput.value = "";
            return;
          }

          const abbrClient = clientName.substring(0,3).toUpperCase();
          const abbrCity = cityName.substring(0,3).toUpperCase();
          const prefix = `${abbrClient}-${abbrCity}`; 

          const existing = allProjects.filter(p => p.code && p.code.startsWith(prefix));
          let maxNum = 0;
          existing.forEach(p => {
            const parts = p.code.split("-");
            const numPart = parseInt(parts[parts.length-1]); 
            if(!isNaN(numPart) && numPart > maxNum) maxNum = numPart;
          });

          const nextNum = maxNum + 1;
          const consecutive = String(nextNum).padStart(4, "0"); 
          codeInput.value = `${prefix}-${consecutive}`;
        }

        // GUARDAR
        form.addEventListener("submit", async (e)=>{
          e.preventDefault();
          try{
            setNotice(msg,"Guardando...","loading");
            
            const clientName = clientSel.value;
            const cityName = citySel.value;
            const clientDoc = allClients.find(c => c.name === clientName && c.city === cityName);
            const clientId = clientDoc ? clientDoc.id : "unknown";

            const respId = respSel.value;
            const respText = respSel.options[respSel.selectedIndex].text; 
            const respName = respText.split(" (")[0]; 

            const payload = {
              code: codeInput.value,
              clientId, 
              clientName,
              city: cityName,
              responsibleUid: respId,
              responsibleName: respName,
              baseAmount: Number(document.querySelector("#p-base").value),
              status: "activo",
              notes: document.querySelector("#p-notes").value.trim(),
              createdAt: fb.serverTimestamp(),
            };

            await fb.addDoc(fb.collection(db,"projects"), payload);
            form.reset();
            citySel.disabled = true;
            setNotice(msg,`Proyecto creado: ${payload.code}`,"success");
            await loadProjectsData();

          }catch(err){
            console.error(err);
            setNotice(msg,"No se pudo guardar.","error");
          }
        });

        // Actualizar estado
        list.addEventListener("change", async (e)=>{
          const sel=e.target;
          if(sel.classList.contains("status")){
            try{
              await fb.updateDoc(fb.doc(db,"projects", sel.dataset.id), { status: sel.value });
            }catch(err){ console.error(err); }
          }
        });

        // Init
        await loadClients();
        await loadResponsibles();
        await loadProjectsData();
      </script>

    </main>
  </div>
</body>
</html>